import { useState } from 'react';
import { MainLayout } from '@/components/layout/MainLayout';
import { Card, CardContent, CardHeader, CardTitle, CardDescription } from '@/components/ui/card';
import { Table, TableBody, TableCell, TableHead, TableHeader, TableRow } from '@/components/ui/table';
import { Badge } from '@/components/ui/badge';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs';
import { useAcademicYear } from '@/hooks/useAcademicYear';
import {
  useMonthlyRevenue,
  useFeeSourceAnalysis,
  useCollectionPerformance,
  useOutstandingFees,
  useExpensePattern,
} from '@/hooks/queries/useAdminFinance';
import { useDailyFinanceSummary } from '@/hooks/queries/useExpenses';
import { Loader2, FileText, Printer, TrendingUp, PieChart, Users, AlertTriangle, BarChart3 } from 'lucide-react';
import { format } from 'date-fns';

const FEE_TYPE_LABELS: Record<string, string> = {
  monthly: '‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶´‡¶ø', admission: '‡¶≠‡¶∞‡ßç‡¶§‡¶ø ‡¶´‡¶ø', session: '‡¶∏‡ßá‡¶∂‡¶® ‡¶ö‡¶æ‡¶∞‡ßç‡¶ú', exam: '‡¶™‡¶∞‡ßÄ‡¶ï‡ßç‡¶∑‡¶æ ‡¶´‡¶ø', product_sales: '‡¶™‡¶£‡ßç‡¶Ø ‡¶¨‡¶ø‡¶ï‡ßç‡¶∞‡¶Ø‡¶º', other: '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø',
};

const CATEGORY_LABELS: Record<string, string> = {
  salary: '‡¶¨‡ßá‡¶§‡¶®', utilities: '‡¶á‡¶â‡¶ü‡¶ø‡¶≤‡¶ø‡¶ü‡¶ø', maintenance: '‡¶Æ‡ßá‡¶∞‡¶æ‡¶Æ‡¶§', supplies: '‡¶∏‡¶∞‡¶¨‡¶∞‡¶æ‡¶π', transport: '‡¶™‡¶∞‡¶ø‡¶¨‡¶π‡¶®', food: '‡¶ñ‡¶æ‡¶¨‡¶æ‡¶∞', other: '‡¶Ö‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶Ø',
};

function PrintHeader({ title, dateRange }: { title: string; dateRange?: string }) {
  return (
    <div className="print-only mb-6 text-center">
      <h2 className="text-xl font-bold">{title}</h2>
      {dateRange && <p className="text-sm">{dateRange}</p>}
      <p className="text-xs text-muted-foreground mt-1">Generated: {format(new Date(), 'dd MMM yyyy, hh:mm a')} | Generated by Amar Hajira Smart</p>
      <hr className="mt-3 border-foreground/30" />
    </div>
  );
}

function DailySummaryReport() {
  const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
  const { data: summary, isLoading } = useDailyFinanceSummary(date);

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between flex-wrap gap-3">
          <CardTitle className="font-bengali flex items-center gap-2">
            <FileText className="w-5 h-5" /> ‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
          </CardTitle>
          <div className="flex items-center gap-3 no-print">
            <Input type="date" value={date} onChange={e => setDate(e.target.value)} className="w-auto" />
            <Button variant="outline" size="sm" onClick={() => window.print()}>
              <Printer className="w-4 h-4 mr-2" /> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
            </Button>
          </div>
        </div>
      </CardHeader>
      <CardContent>
        <PrintHeader title="‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂" dateRange={format(new Date(date), 'dd MMMM yyyy')} />
        {isLoading ? (
          <div className="flex justify-center py-8"><Loader2 className="w-6 h-6 animate-spin" /></div>
        ) : (
          <div className="space-y-4">
            <div className="grid grid-cols-1 md:grid-cols-3 gap-4">
              <div className="p-4 border rounded-lg text-center">
                <p className="text-sm text-muted-foreground font-bengali">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</p>
                <p className="text-2xl font-bold text-emerald-600">‡ß≥{summary?.total_collection?.toLocaleString() || 0}</p>
                <p className="text-xs text-muted-foreground">{summary?.transaction_count || 0} ‡¶ü‡¶ø ‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®</p>
              </div>
              <div className="p-4 border rounded-lg text-center">
                <p className="text-sm text-muted-foreground font-bengali">‡¶Æ‡ßã‡¶ü ‡¶ñ‡¶∞‡¶ö</p>
                <p className="text-2xl font-bold text-red-600">‡ß≥{summary?.total_expenses?.toLocaleString() || 0}</p>
                <p className="text-xs text-muted-foreground">{summary?.expense_count || 0} ‡¶ü‡¶ø ‡¶è‡¶®‡ßç‡¶ü‡ßç‡¶∞‡¶ø</p>
              </div>
              <div className="p-4 border rounded-lg text-center">
                <p className="text-sm text-muted-foreground font-bengali">‡¶®‡ßá‡¶ü ‡¶¨‡ßç‡¶Ø‡¶æ‡¶≤‡ßá‡¶®‡ßç‡¶∏</p>
                <p className={`text-2xl font-bold ${(summary?.net_balance || 0) < 0 ? 'text-red-600' : 'text-blue-600'}`}>
                  ‡ß≥{summary?.net_balance?.toLocaleString() || 0}
                </p>
              </div>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

function MonthlyRevenueReport() {
  const { activeYear } = useAcademicYear();
  const { data, isLoading } = useMonthlyRevenue(activeYear?.id);

  const totalIncome = data?.reduce((s, m) => s + m.income, 0) || 0;
  const totalExpense = data?.reduce((s, m) => s + m.expense, 0) || 0;

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between flex-wrap gap-3">
          <CardTitle className="font-bengali flex items-center gap-2">
            <TrendingUp className="w-5 h-5" /> ‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡ßá‡¶≠‡¶ø‡¶®‡¶ø‡¶â ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
          </CardTitle>
          <Button variant="outline" size="sm" onClick={() => window.print()} className="no-print">
            <Printer className="w-4 h-4 mr-2" /> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <PrintHeader title="‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡ßá‡¶≠‡¶ø‡¶®‡¶ø‡¶â ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü" dateRange={`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑: ${activeYear?.name || ''}`} />
        {isLoading ? (
          <div className="flex justify-center py-8"><Loader2 className="w-6 h-6 animate-spin" /></div>
        ) : !data?.length ? (
          <p className="text-center py-8 text-muted-foreground font-bengali">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</p>
        ) : (
          <>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="font-bengali">‡¶Æ‡¶æ‡¶∏</TableHead>
                  <TableHead className="text-right font-bengali">‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</TableHead>
                  <TableHead className="text-right font-bengali">‡¶ñ‡¶∞‡¶ö</TableHead>
                  <TableHead className="text-right font-bengali">‡¶®‡ßá‡¶ü</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {data.map(m => (
                  <TableRow key={m.month}>
                    <TableCell className="font-medium">{m.month}</TableCell>
                    <TableCell className="text-right text-emerald-600 font-semibold">‡ß≥{m.income.toLocaleString()}</TableCell>
                    <TableCell className="text-right text-red-600 font-semibold">‡ß≥{m.expense.toLocaleString()}</TableCell>
                    <TableCell className={`text-right font-bold ${m.net < 0 ? 'text-red-600' : ''}`}>‡ß≥{m.net.toLocaleString()}</TableCell>
                  </TableRow>
                ))}
                <TableRow className="border-t-2 font-bold">
                  <TableCell className="font-bengali">‡¶Æ‡ßã‡¶ü</TableCell>
                  <TableCell className="text-right text-emerald-600">‡ß≥{totalIncome.toLocaleString()}</TableCell>
                  <TableCell className="text-right text-red-600">‡ß≥{totalExpense.toLocaleString()}</TableCell>
                  <TableCell className={`text-right ${totalIncome - totalExpense < 0 ? 'text-red-600' : ''}`}>‡ß≥{(totalIncome - totalExpense).toLocaleString()}</TableCell>
                </TableRow>
              </TableBody>
            </Table>
          </>
        )}
      </CardContent>
    </Card>
  );
}

function FeeSourceReport() {
  const { activeYear } = useAcademicYear();
  const { data, isLoading } = useFeeSourceAnalysis(activeYear?.id);
  const total = data?.reduce((s, d) => s + d.amount, 0) || 0;

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between flex-wrap gap-3">
          <CardTitle className="font-bengali flex items-center gap-2">
            <PieChart className="w-5 h-5" /> ‡¶´‡¶ø ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£
          </CardTitle>
          <Button variant="outline" size="sm" onClick={() => window.print()} className="no-print">
            <Printer className="w-4 h-4 mr-2" /> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <PrintHeader title="‡¶´‡¶ø ‡¶∏‡ßã‡¶∞‡ßç‡¶∏ ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü" dateRange={`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑: ${activeYear?.name || ''}`} />
        {isLoading ? (
          <div className="flex justify-center py-8"><Loader2 className="w-6 h-6 animate-spin" /></div>
        ) : (
          <>
            <Table>
              <TableHeader>
                <TableRow>
                  <TableHead className="font-bengali">‡¶∏‡ßã‡¶∞‡ßç‡¶∏</TableHead>
                  <TableHead className="text-right font-bengali">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</TableHead>
                  <TableHead className="text-right font-bengali">‡¶∂‡¶§‡¶æ‡¶Ç‡¶∂</TableHead>
                  <TableHead className="font-bengali">‡¶Ö‡¶®‡ßÅ‡¶™‡¶æ‡¶§</TableHead>
                </TableRow>
              </TableHeader>
              <TableBody>
                {data?.map(d => (
                  <TableRow key={d.source}>
                    <TableCell className="font-medium font-bengali">{FEE_TYPE_LABELS[d.source] || d.source}</TableCell>
                    <TableCell className="text-right font-semibold">‡ß≥{d.amount.toLocaleString()}</TableCell>
                    <TableCell className="text-right">{d.percentage}%</TableCell>
                    <TableCell>
                      <div className="w-full bg-muted rounded-full h-2">
                        <div className="bg-primary h-2 rounded-full" style={{ width: `${d.percentage}%` }} />
                      </div>
                    </TableCell>
                  </TableRow>
                ))}
                <TableRow className="border-t-2 font-bold">
                  <TableCell className="font-bengali">‡¶Æ‡ßã‡¶ü</TableCell>
                  <TableCell className="text-right">‡ß≥{total.toLocaleString()}</TableCell>
                  <TableCell className="text-right">100%</TableCell>
                  <TableCell />
                </TableRow>
              </TableBody>
            </Table>
          </>
        )}
      </CardContent>
    </Card>
  );
}

function CollectionPerformanceReport() {
  const { activeYear } = useAcademicYear();
  const { data, isLoading } = useCollectionPerformance(activeYear?.id);

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between flex-wrap gap-3">
          <CardTitle className="font-bengali flex items-center gap-2">
            <Users className="w-5 h-5" /> ‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏
          </CardTitle>
          <Button variant="outline" size="sm" onClick={() => window.print()} className="no-print">
            <Printer className="w-4 h-4 mr-2" /> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <PrintHeader title="‡¶ï‡¶æ‡¶≤‡ßá‡¶ï‡¶∂‡¶® ‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü" dateRange={`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑: ${activeYear?.name || ''}`} />
        {isLoading ? (
          <div className="flex justify-center py-8"><Loader2 className="w-6 h-6 animate-spin" /></div>
        ) : !data?.length ? (
          <p className="text-center py-8 text-muted-foreground font-bengali">‡¶ï‡ßã‡¶®‡ßã ‡¶°‡¶æ‡¶ü‡¶æ ‡¶™‡¶æ‡¶ì‡¶Ø‡¶º‡¶æ ‡¶Ø‡¶æ‡¶Ø‡¶º‡¶®‡¶ø</p>
        ) : (
          <Table>
            <TableHeader>
              <TableRow>
                <TableHead className="font-bengali">‡¶Ö‡¶™‡¶æ‡¶∞‡ßá‡¶ü‡¶∞</TableHead>
                <TableHead className="text-right font-bengali">‡¶Æ‡ßã‡¶ü ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</TableHead>
                <TableHead className="text-right font-bengali">‡¶ü‡ßç‡¶∞‡¶æ‡¶®‡¶ú‡ßá‡¶ï‡¶∂‡¶®</TableHead>
                <TableHead className="text-right font-bengali">‡¶ó‡¶°‡¶º ‡¶Ü‡¶¶‡¶æ‡¶Ø‡¶º</TableHead>
              </TableRow>
            </TableHeader>
            <TableBody>
              {data.map(d => (
                <TableRow key={d.operator_id}>
                  <TableCell className="font-medium">{d.operator_name}</TableCell>
                  <TableCell className="text-right font-semibold">‡ß≥{d.total_amount.toLocaleString()}</TableCell>
                  <TableCell className="text-right">{d.transaction_count}</TableCell>
                  <TableCell className="text-right">‡ß≥{d.average.toLocaleString()}</TableCell>
                </TableRow>
              ))}
            </TableBody>
          </Table>
        )}
      </CardContent>
    </Card>
  );
}

function OutstandingReport() {
  const { activeYear } = useAcademicYear();
  const { data, isLoading } = useOutstandingFees(activeYear?.id);

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between flex-wrap gap-3">
          <CardTitle className="font-bengali flex items-center gap-2">
            <AlertTriangle className="w-5 h-5" /> ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶´‡¶ø ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
          </CardTitle>
          <Button variant="outline" size="sm" onClick={() => window.print()} className="no-print">
            <Printer className="w-4 h-4 mr-2" /> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
          </Button>
        </div>
      </CardHeader>
      <CardContent>
        <PrintHeader title="‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶´‡¶ø ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü" dateRange={`‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶¨‡¶∞‡ßç‡¶∑: ${activeYear?.name || ''}`} />
        {isLoading ? (
          <div className="flex justify-center py-8"><Loader2 className="w-6 h-6 animate-spin" /></div>
        ) : (
          <div className="space-y-6">
            {/* Summary */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <div className="p-4 border rounded-lg text-center">
                <p className="text-sm text-muted-foreground font-bengali">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</p>
                <p className="text-2xl font-bold text-red-600">‡ß≥{data?.totalDue?.toLocaleString() || 0}</p>
              </div>
              <div className="p-4 border rounded-lg text-center">
                <p className="text-sm text-muted-foreground font-bengali">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶°</p>
                <p className="text-2xl font-bold">{data?.totalRecords || 0}</p>
              </div>
            </div>

            {/* Class-wise */}
            <div>
              <h3 className="font-semibold mb-3 font-bengali">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</h3>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="font-bengali">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ</TableHead>
                    <TableHead className="text-right font-bengali">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</TableHead>
                    <TableHead className="text-right font-bengali">‡¶∞‡ßá‡¶ï‡¶∞‡ßç‡¶° ‡¶∏‡¶Ç‡¶ñ‡ßç‡¶Ø‡¶æ</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {data?.classDues?.map(c => (
                    <TableRow key={c.name}>
                      <TableCell className="font-medium">{c.name}</TableCell>
                      <TableCell className="text-right font-semibold text-red-600">‡ß≥{c.total.toLocaleString()}</TableCell>
                      <TableCell className="text-right">{c.count}</TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>

            {/* Top Defaulters */}
            {data?.topDefaulters && data.topDefaulters.length > 0 && (
              <div>
                <h3 className="font-semibold mb-3 font-bengali">üî¥ ‡¶¨‡¶æ‡¶∞‡¶¨‡¶æ‡¶∞ ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ‡¶¶‡¶æ‡¶∞ (‡ß©+ ‡¶Æ‡¶æ‡¶∏)</h3>
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead className="font-bengali">‡¶∂‡¶ø‡¶ï‡ßç‡¶∑‡¶æ‡¶∞‡ßç‡¶•‡ßÄ</TableHead>
                      <TableHead className="font-bengali">‡¶∂‡ßç‡¶∞‡ßá‡¶£‡ßÄ</TableHead>
                      <TableHead className="text-right font-bengali">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶Æ‡¶æ‡¶∏</TableHead>
                      <TableHead className="text-right font-bengali">‡¶Æ‡ßã‡¶ü ‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {data.topDefaulters.map((d, i) => (
                      <TableRow key={i}>
                        <TableCell className="font-medium">{d.name}</TableCell>
                        <TableCell>{d.className}</TableCell>
                        <TableCell className="text-right">
                          <Badge variant="destructive">{d.unpaidMonths}</Badge>
                        </TableCell>
                        <TableCell className="text-right font-semibold text-red-600">‡ß≥{d.totalDue.toLocaleString()}</TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            )}
          </div>
        )}
      </CardContent>
    </Card>
  );
}

function ExpensePatternReport() {
  const { data, isLoading } = useExpensePattern(30);

  return (
    <Card>
      <CardHeader>
        <div className="flex items-center justify-between flex-wrap gap-3">
          <CardTitle className="font-bengali flex items-center gap-2">
            <BarChart3 className="w-5 h-5" /> ‡¶ñ‡¶∞‡¶ö ‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü
          </CardTitle>
          <Button variant="outline" size="sm" onClick={() => window.print()} className="no-print">
            <Printer className="w-4 h-4 mr-2" /> ‡¶™‡ßç‡¶∞‡¶ø‡¶®‡ßç‡¶ü
          </Button>
        </div>
        <CardDescription className="font-bengali">‡¶ó‡¶§ ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶®‡ßá‡¶∞ ‡¶ñ‡¶∞‡¶ö ‡¶¨‡¶ø‡¶∂‡ßç‡¶≤‡ßá‡¶∑‡¶£</CardDescription>
      </CardHeader>
      <CardContent>
        <PrintHeader title="‡¶ñ‡¶∞‡¶ö ‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶® ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü" dateRange="‡¶ó‡¶§ ‡ß©‡ß¶ ‡¶¶‡¶ø‡¶®" />
        {isLoading ? (
          <div className="flex justify-center py-8"><Loader2 className="w-6 h-6 animate-spin" /></div>
        ) : (
          <div className="space-y-6">
            {/* Average */}
            <div className="p-4 border rounded-lg text-center">
              <p className="text-sm text-muted-foreground font-bengali">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ó‡¶°‡¶º ‡¶ñ‡¶∞‡¶ö</p>
              <p className="text-2xl font-bold">‡ß≥{data?.avgDaily?.toLocaleString() || 0}</p>
            </div>

            {/* Category breakdown */}
            <div>
              <h3 className="font-semibold mb-3 font-bengali">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö</h3>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="font-bengali">‡¶ï‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶ó‡¶∞‡¶ø</TableHead>
                    <TableHead className="text-right font-bengali">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {data?.categoryTotals?.map(c => (
                    <TableRow key={c.category}>
                      <TableCell className="font-medium font-bengali">{CATEGORY_LABELS[c.category] || c.category}</TableCell>
                      <TableCell className="text-right font-semibold">‡ß≥{c.amount.toLocaleString()}</TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>

            {/* Spikes */}
            {data?.spikes && data.spikes.length > 0 && (
              <div>
                <h3 className="font-semibold mb-3 font-bengali">‚ö†Ô∏è ‡¶Ö‡¶∏‡ßç‡¶¨‡¶æ‡¶≠‡¶æ‡¶¨‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö (‡¶ó‡¶°‡¶º‡ßá‡¶∞ ‡ß®x+)</h3>
                <Table>
                  <TableHeader>
                    <TableRow>
                      <TableHead className="font-bengali">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</TableHead>
                      <TableHead className="text-right font-bengali">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</TableHead>
                      <TableHead className="text-right font-bengali">‡¶ó‡¶°‡¶º‡ßá‡¶∞ ‡¶§‡ßÅ‡¶≤‡¶®‡¶æ‡¶Ø‡¶º</TableHead>
                    </TableRow>
                  </TableHeader>
                  <TableBody>
                    {data.spikes.map(s => (
                      <TableRow key={s.date}>
                        <TableCell>{format(new Date(s.date), 'dd MMM yyyy')}</TableCell>
                        <TableCell className="text-right font-semibold text-red-600">‡ß≥{s.amount.toLocaleString()}</TableCell>
                        <TableCell className="text-right">
                          <Badge variant="destructive">{s.ratio}x</Badge>
                        </TableCell>
                      </TableRow>
                    ))}
                  </TableBody>
                </Table>
              </div>
            )}

            {/* Daily trend */}
            <div>
              <h3 className="font-semibold mb-3 font-bengali">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶ñ‡¶∞‡¶ö ‡¶ü‡ßç‡¶∞‡ßá‡¶®‡ßç‡¶°</h3>
              <Table>
                <TableHeader>
                  <TableRow>
                    <TableHead className="font-bengali">‡¶§‡¶æ‡¶∞‡¶ø‡¶ñ</TableHead>
                    <TableHead className="text-right font-bengali">‡¶™‡¶∞‡¶ø‡¶Æ‡¶æ‡¶£</TableHead>
                  </TableRow>
                </TableHeader>
                <TableBody>
                  {data?.dailyTrend?.slice(-15).map(d => (
                    <TableRow key={d.date}>
                      <TableCell>{format(new Date(d.date), 'dd MMM yyyy')}</TableCell>
                      <TableCell className="text-right font-semibold">‡ß≥{d.amount.toLocaleString()}</TableCell>
                    </TableRow>
                  ))}
                </TableBody>
              </Table>
            </div>
          </div>
        )}
      </CardContent>
    </Card>
  );
}

export default function AdminFinanceReports() {
  return (
    <MainLayout title="Finance Reports" titleBn="‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü">
      <div className="space-y-6">
        <div>
          <h1 className="text-2xl font-bold flex items-center gap-2">
            <FileText className="w-7 h-7 text-primary" />
            <span className="font-bengali">‡¶´‡¶æ‡¶á‡¶®‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏ ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶∏‡¶Æ‡ßÇ‡¶π</span>
          </h1>
          <p className="text-muted-foreground font-bengali">‡¶∏‡ßÅ‡¶™‡¶æ‡¶∞ ‡¶è‡¶°‡¶Æ‡¶ø‡¶® ‚Äî ‡¶∏‡¶¨ ‡¶ß‡¶∞‡¶®‡ßá‡¶∞ ‡¶Ü‡¶∞‡ßç‡¶•‡¶ø‡¶ï ‡¶∞‡¶ø‡¶™‡ßã‡¶∞‡ßç‡¶ü ‡¶è‡¶ñ‡¶æ‡¶®‡ßá</p>
        </div>

        <Tabs defaultValue="daily" className="w-full">
          <TabsList className="flex flex-wrap h-auto gap-1 no-print">
            <TabsTrigger value="daily" className="font-bengali">‡¶¶‡ßà‡¶®‡¶ø‡¶ï ‡¶∏‡¶æ‡¶∞‡¶æ‡¶Ç‡¶∂</TabsTrigger>
            <TabsTrigger value="monthly" className="font-bengali">‡¶Æ‡¶æ‡¶∏‡¶ø‡¶ï ‡¶∞‡ßá‡¶≠‡¶ø‡¶®‡¶ø‡¶â</TabsTrigger>
            <TabsTrigger value="source" className="font-bengali">‡¶´‡¶ø ‡¶∏‡ßã‡¶∞‡ßç‡¶∏</TabsTrigger>
            <TabsTrigger value="performance" className="font-bengali">‡¶™‡¶æ‡¶∞‡¶´‡¶∞‡¶Æ‡ßç‡¶Ø‡¶æ‡¶®‡ßç‡¶∏</TabsTrigger>
            <TabsTrigger value="outstanding" className="font-bengali">‡¶¨‡¶ï‡ßá‡¶Ø‡¶º‡¶æ ‡¶ù‡ßÅ‡¶Å‡¶ï‡¶ø</TabsTrigger>
            <TabsTrigger value="expense" className="font-bengali">‡¶ñ‡¶∞‡¶ö ‡¶™‡ßç‡¶Ø‡¶æ‡¶ü‡¶æ‡¶∞‡ßç‡¶®</TabsTrigger>
          </TabsList>

          <TabsContent value="daily"><DailySummaryReport /></TabsContent>
          <TabsContent value="monthly"><MonthlyRevenueReport /></TabsContent>
          <TabsContent value="source"><FeeSourceReport /></TabsContent>
          <TabsContent value="performance"><CollectionPerformanceReport /></TabsContent>
          <TabsContent value="outstanding"><OutstandingReport /></TabsContent>
          <TabsContent value="expense"><ExpensePatternReport /></TabsContent>
        </Tabs>
      </div>
    </MainLayout>
  );
}
